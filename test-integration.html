<!DOCTYPE html>
<html>
<head>
    <title>NexusRemote é›†æˆæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #0f172a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 20px; margin: 10px 0; border-radius: 8px; }
        .connected { background: #10b981; }
        .disconnected { background: #ef4444; }
        .connecting { background: #f59e0b; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .connect-btn { background: #3b82f6; color: white; }
        .test-btn { background: #6366f1; color: white; }
        .log { background: #1e293b; padding: 15px; border-radius: 8px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #3b82f6; }
        .success { border-left-color: #10b981; }
        .error { border-left-color: #ef4444; }
        .info { border-left-color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— NexusRemote å‰åç«¯é›†æˆæµ‹è¯•</h1>
        
        <div class="status disconnected" id="status">
            <h2>çŠ¶æ€: <span id="status-text">æœªè¿æ¥</span></h2>
            <p>Rust WebSocketæœåŠ¡å™¨: ws://localhost:8081</p>
            <p>å‰ç«¯æœåŠ¡å™¨: http://localhost:3000</p>
            <p>Pythonåç«¯: http://localhost:5000</p>
        </div>
        
        <div>
            <button class="connect-btn" onclick="connectWebSocket()">è¿æ¥ WebSocket</button>
            <button class="test-btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="test-btn" onclick="testFullIntegration()">å®Œæ•´é›†æˆæµ‹è¯•</button>
        </div>
        
        <div class="log" id="log">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="log-entries"></div>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>æœåŠ¡çŠ¶æ€</h3>
            <div id="service-status"></div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let clientId = null;
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('log-entries').appendChild(entry);
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }
        
        function updateStatus(status, isConnected = false) {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = status;
            statusDiv.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
            
            if (status === 'è¿æ¥ä¸­...') {
                statusDiv.className = 'status connecting';
            }
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
                updateStatus('æœªè¿æ¥', false);
                log('å·²æ–­å¼€WebSocketè¿æ¥', 'info');
                return;
            }
            
            updateStatus('è¿æ¥ä¸­...', false);
            log('æ­£åœ¨è¿æ¥ ws://localhost:8081 ...', 'info');
            
            try {
                ws = new WebSocket('ws://localhost:8081');
                
                ws.onopen = function(event) {
                    updateStatus('å·²è¿æ¥', true);
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info');
                        
                        switch(data.type) {
                            case 'welcome':
                                clientId = data.client_id;
                                log(`å®¢æˆ·ç«¯ID: ${clientId}`, 'success');
                                break;
                            case 'pong':
                                log(`ğŸ“ å¿ƒè·³å“åº”: ${new Date(data.timestamp * 1000).toLocaleTimeString()}`, 'success');
                                break;
                            case 'routing_stats':
                                log(`ğŸ“Š è·¯ç”±ç»Ÿè®¡: ${data.total_peers}ä¸ªèŠ‚ç‚¹, ${data.expected_advantage}xä¼˜åŠ¿`, 'success');
                                break;
                            case 'command_result':
                                log(`ğŸ¯ å‘½ä»¤ç»“æœ: ${data.command} â†’ ${data.status}`, 'success');
                                break;
                        }
                    } catch (e) {
                        log(`âŒ è§£ææ¶ˆæ¯å¤±è´¥: ${e.message}`, 'error');
                    }
                };
                
                ws.onerror = function(error) {
                    log('âŒ WebSocketè¿æ¥é”™è¯¯', 'error');
                    updateStatus('è¿æ¥é”™è¯¯', false);
                };
                
                ws.onclose = function(event) {
                    log('ğŸ”Œ WebSocketè¿æ¥å…³é—­', 'info');
                    updateStatus('æœªè¿æ¥', false);
                    ws = null;
                };
                
            } catch (error) {
                log(`âŒ åˆ›å»ºWebSocketå¤±è´¥: ${error.message}`, 'error');
                updateStatus('è¿æ¥å¤±è´¥', false);
            }
        }
        
        function testConnection() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ è¯·å…ˆè¿æ¥WebSocket', 'error');
                return;
            }
            
            // å‘é€ping
            ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
            log('å‘é€pingæ¶ˆæ¯', 'info');
            
            // è·å–è·¯ç”±ç»Ÿè®¡
            setTimeout(() => {
                ws.send(JSON.stringify({ type: 'get_routing_stats' }));
                log('è¯·æ±‚è·¯ç”±ç»Ÿè®¡', 'info');
            }, 500);
            
            // å‘é€æµ‹è¯•å‘½ä»¤
            setTimeout(() => {
                ws.send(JSON.stringify({ 
                    type: 'send_command', 
                    command: 'test_integration', 
                    target: 'test_device' 
                }));
                log('å‘é€æµ‹è¯•å‘½ä»¤', 'info');
            }, 1000);
        }
        
        function testFullIntegration() {
            log('ğŸš€ å¼€å§‹å®Œæ•´é›†æˆæµ‹è¯•...', 'info');
            
            // æµ‹è¯•å‰ç«¯æœåŠ¡å™¨
            fetch('http://localhost:3000/api/devices')
                .then(response => response.json())
                .then(data => {
                    log(`âœ… å‰ç«¯API: è·å–åˆ°${data.devices?.length || 0}ä¸ªè®¾å¤‡`, 'success');
                })
                .catch(error => {
                    log(`âŒ å‰ç«¯APIé”™è¯¯: ${error.message}`, 'error');
                });
            
            // æµ‹è¯•Pythonåç«¯
            fetch('http://localhost:5000/api/health')
                .then(response => response.json())
                .then(data => {
                    log(`âœ… Pythonåç«¯: ${data.status}`, 'success');
                })
                .catch(error => {
                    log(`âŒ Pythonåç«¯é”™è¯¯: ${error.message}`, 'error');
                });
            
            // æµ‹è¯•åŠ æƒè·¯ç”±ç®—æ³•
            fetch('http://localhost:5000/api/routing/algorithm')
                .then(response => response.json())
                .then(data => {
                    log(`âœ… åŠ æƒè·¯ç”±ç®—æ³•: ${data.advantage_ratio}xä¼˜åŠ¿`, 'success');
                })
                .catch(error => {
                    log(`âŒ è·¯ç”±ç®—æ³•é”™è¯¯: ${error.message}`, 'error');
                });
            
            // æµ‹è¯•WebSocketè¿æ¥
            if (ws && ws.readyState === WebSocket.OPEN) {
                testConnection();
            } else {
                log('âš ï¸ WebSocketæœªè¿æ¥ï¼Œè·³è¿‡WebSocketæµ‹è¯•', 'info');
            }
        }
        
        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        function checkServices() {
            const services = [
                { name: 'å‰ç«¯æœåŠ¡å™¨', url: 'http://localhost:3000/api/devices' },
                { name: 'Pythonåç«¯', url: 'http://localhost:5000/api/health' },
                { name: 'Rust WebSocket', url: null } // WebSocketéœ€è¦ç‰¹æ®Šå¤„ç†
            ];
            
            const statusDiv = document.getElementById('service-status');
            statusDiv.innerHTML = '';
            
            services.forEach(service => {
                const div = document.createElement('div');
                div.style.margin = '5px 0';
                div.style.padding = '5px';
                div.style.borderRadius = '4px';
                div.style.backgroundColor = '#334155';
                
                if (service.url) {
                    fetch(service.url)
                        .then(response => {
                            div.innerHTML = `âœ… ${service.name}: è¿è¡Œæ­£å¸¸`;
                            div.style.backgroundColor = '#065f46';
                        })
                        .catch(error => {
                            div.innerHTML = `âŒ ${service.name}: æ— æ³•è¿æ¥`;
                            div.style.backgroundColor = '#7f1d1d';
                        });
                } else {
                    // æ£€æŸ¥WebSocketæœåŠ¡å™¨
                    const testWs = new WebSocket('ws://localhost:8081');
                    testWs.onopen = () => {
                        div.innerHTML = `âœ… ${service.name}: è¿è¡Œæ­£å¸¸`;
                        div.style.backgroundColor = '#065f46';
                        testWs.close();
                    };
                    testWs.onerror = () => {
                        div.innerHTML = `âŒ ${service.name}: æ— æ³•è¿æ¥`;
                        div.style.backgroundColor = '#7f1d1d';
                    };
                }
                
                statusDiv.appendChild(div);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            setTimeout(checkServices, 1000);
        };
    </script>
</body>
</html>